version: '3'

tasks:
  # --- Infrastructure ---
  up: 
    desc: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ãƒ•ãƒ©ï¼ˆDBãªã©ï¼‰ã‚’èµ·å‹•ã—ã¾ã™
    cmds:
      - docker-compose -f infra/local/docker-compose.yml up -d
      - echo Infrastructure is UP
      - echo MinIO Console http://localhost:9001
      - echo Qdrant API http://localhost:6333  
  down:
    desc: ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ãƒ•ãƒ©ã‚’åœæ­¢ã—ã¾ã™
    cmds:
      - docker compose -f infra/local/docker-compose.yml down
      - echo ğŸ’¤ Infrastructure is DOWN.
  
  logs:
    desc: ã‚¤ãƒ³ãƒ•ãƒ©ã®ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¾ã™
    cmds:
      - docker compose -f infra/local/docker-compose.yml logs -f

  # --- Code Generation ---
  generate-api:
    desc: OpenAPI ã‹ã‚‰ Go ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    dir: apps/api-gateway
    cmds:
      - oapi-codegen -config configs/oapi-codegen.yaml ../../packages/openapi/openapi.yaml  
      - echo âœ… API code generated

  generate-sqlc:
    desc: SQLC ã§ã‚¯ã‚¨ãƒªã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
    dir: apps/api-gateway
    cmds:
      - sqlc generate
      - echo âœ… SQLC code generated

  generate:
    desc: å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œ
    cmds:
      - task: generate-api
      - task: generate-sqlc

  # --- Setup ---
  init-go:
    desc: Goãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿å®Ÿè¡Œï¼‰
    dir: apps/api-gateway
    cmds:
      - go mod init nexus/api-gateway
      - echo âœ… Go module initialized

  # --- Frontend ---
  dev-web:
    desc: Next.jsï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰ã‚’èµ·å‹•ã—ã¾ã™
    dir: apps/web/nexus
    cmds:
      - npm run dev

  # --- Backend ---
  dev-back:
    desc: Goï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰ã‚’èµ·å‹•ã—ã¾ã™
    dir: apps/api-gateway
    cmds:
      - go run cmd/server/main.go

  # --- All ---
  dev:
    desc: ã‚¤ãƒ³ãƒ•ãƒ©ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’åŒæ™‚ã«èµ·å‹•ã—ã¾ã™
    deps: 
      - up # å…ˆã«dockerãŒç«‹ã¡ä¸ŠãŒã‚‹ã‚ˆã†ã«ä¾å­˜é–¢ä¿‚ã‚’è¨­å®š
      - dev-back
      - dev-web
    parallel: true

  ai:
    desc: AIã®ç«‹ã¡ä¸Šã’
    dir: apps/ai-worker
    cmds:
      - uvicorn main:app --reload --host 0.0.0.0 --port 8001

  # --- Status Check ---
  status:
    desc: ã‚³ãƒ³ãƒ†ãƒŠã®çŠ¶æ…‹ç¢ºèª
    cmds:
      - docker compose -f infra/local/docker-compose.yml ps

# --- Database Migration ---
  migrate:up:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨
    dir: apps/api-gateway/migrations
    cmds:
      - goose postgres "host=localhost port=5432 user=user password=password dbname=nexus sslmode=disable" up
      - echo âœ… Migration completed

  migrate:down:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ã¤æˆ»ã™
    dir: apps/api-gateway/migrations
    cmds:
      - goose postgres "host=localhost port=5432 user=user password=password dbname=nexus sslmode=disable" down
      - echo âª Rolled back 1 migration

  migrate:status:
    desc: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
    dir: apps/api-gateway/migrations
    cmds:
      - goose postgres "host=localhost port=5432 user=user password=password dbname=nexus sslmode=disable" status

  migrate:reset:
    desc: å…¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    dir: apps/api-gateway/migrations
    cmds:
      - goose postgres "host=localhost port=5432 user=user password=password dbname=nexus sslmode=disable" reset
      - echo âš ï¸  All migrations rolled back